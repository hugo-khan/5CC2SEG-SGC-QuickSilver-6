{% extends 'base_content.html' %}
{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-lg-10">
      <div class="alert alert-info d-flex align-items-center" role="alert">
        <span class="me-2">ðŸ”—</span>
        <div>
          <strong>Shared Recipe</strong> - This recipe has been shared with you.
          {% if not user.is_authenticated %}
            <a href="{% url 'sign_up' %}" class="alert-link">Sign up</a> or 
            <a href="{% url 'log_in' %}" class="alert-link">log in</a> to save this recipe to your favorites!
          {% endif %}
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
        <div>
          <h1>{{ recipe.title }}</h1>
          <p class="text-muted mb-1">By {{ recipe.author.full_name }} ({{ recipe.author.username }})</p>
          <p class="text-muted">Published {{ recipe.created_at|date:"j M Y" }}</p>
        </div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-primary" onclick="shareRecipe()">
            ðŸ“¤ Share
          </button>
          <button type="button" class="btn btn-outline-secondary" onclick="copyShareLink()">
            ðŸ“‹ Copy Link
          </button>
        </div>
      </div>

      {% if recipe.summary %}
        <p class="mt-3">{{ recipe.summary }}</p>
      {% endif %}

      <div class="row mt-4">
        <div class="col-md-6">
          <h3>Ingredients</h3>
          <pre class="bg-light p-3 rounded">{{ recipe.ingredients }}</pre>
        </div>
        <div class="col-md-6">
          <h3>Instructions</h3>
          <pre class="bg-light p-3 rounded">{{ recipe.instructions }}</pre>
        </div>
      </div>

      <div class="mt-4">
        <h5>Details</h5>
        <ul class="list-unstyled">
          {% if recipe.prep_time_minutes %}<li>Prep time: {{ recipe.prep_time_minutes }} min</li>{% endif %}
          {% if recipe.cook_time_minutes %}<li>Cook time: {{ recipe.cook_time_minutes }} min</li>{% endif %}
          {% if recipe.total_time_minutes %}<li>Total time: {{ recipe.total_time_minutes }} min</li>{% endif %}
          {% if recipe.servings %}<li>Servings: {{ recipe.servings }}</li>{% endif %}
          {% if recipe.difficulty %}<li>Difficulty: {{ recipe.get_difficulty_display }}</li>{% endif %}
          {% if recipe.dietary_requirement != 'none' %}<li>Dietary: {{ recipe.get_dietary_requirement_display }}</li>{% endif %}
        </ul>
      </div>

      <div class="mt-4">
        <p class="text-muted">
          <a href="{% url 'recipe_detail' recipe.pk %}" class="btn btn-primary">
            View on Recipify
          </a>
          {% if not user.is_authenticated %}
            <a href="{% url 'sign_up' %}" class="btn btn-outline-primary ms-2">
              Create Account to Save
            </a>
          {% endif %}
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  const shareUrl = "{{ share_url }}";
  const recipeTitle = "{{ recipe.title }}";
  const recipeSummary = "{{ recipe.summary|default:recipe.title }}";

  // Native Web Share API (works on mobile devices)
  async function shareRecipe() {
    const shareData = {
      title: recipeTitle,
      text: recipeSummary,
      url: shareUrl
    };

    try {
      if (navigator.share) {
        await navigator.share(shareData);
      } else {
        // Fallback: copy to clipboard
        copyShareLink();
      }
    } catch (err) {
      // User cancelled or error occurred
      if (err.name !== 'AbortError') {
        copyShareLink();
      }
    }
  }

  // Copy link to clipboard
  function copyShareLink() {
    navigator.clipboard.writeText(shareUrl).then(() => {
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = 'âœ“ Copied!';
      button.classList.remove('btn-outline-secondary');
      button.classList.add('btn-success');
      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-secondary');
      }, 2000);
    }).catch(() => {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = shareUrl;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      alert('Link copied to clipboard!');
    });
  }
</script>
{% endblock %}

